extends layout

block content
  style.
      #editor { 
      width:500px;
      height:400px;
      }
  <script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/ace.js"></script>
  .row
    h3 Professional Dota 2 Data Explorer
    .col-md-6
      h4 SQL
      //pre: code=sql
      #editor=sql
      button.btn.btn-primary(onclick="query()") Query
      button.btn.btn-success(onclick="share()") Share
    .col-md-6
      h4 Result
      pre#result= (err || result)
  script.
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/sql");
    editor.setShowPrintMargin(false);
    
    var uq = parseUrlQueryString(window.location.href);
    console.log(uq);
    if (uq.qid)
    {
       fetch('/api/explorer/query/'+uq.qid).then(function(response) {
          return response.json();
          })
        .then(function(json){
            //TODO set query name
            editor.setValue(json.query);
            query();
        });
    }
    function query()
    {
        fetch('/api/explorer?sql='+getSqlString())
        .then(function(response) {
          return response.json();
          })
        .then(function(json){
          document.getElementById('result').innerHTML = JSON.stringify(json, null, 2);
        });
    }
    function share()
    {
      fetch('/api/explorer/query', {
      	method: 'post',
      	headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
      	body: JSON.stringify({name: '', query: getSqlString()})
      }).then(function(response){
        return response.json();
      })
      .then(function(json){
         window.history.pushState('', '', '?qid='+json.id);
      });
    }
    function getSqlString()
    {
        return editor.getValue().replace(/\n/g, " ");
    }
    function parseUrlQueryString(a)
    {
      var b = {};
      var qs = a.split("?")[1].split("&");
      qs.forEach(function(q){var s = q.split('=');
        b[s[0]] = decodeURIComponent(s[1]);
      });
      return b;
    }